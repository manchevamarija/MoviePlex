@model MoviesApp.ViewModels.MovieIndexViewModel
@using Microsoft.AspNetCore.Identity
@using MoviesApp.Models


@{
    ViewData["Title"] = "Сите филмови";
    bool isLoggedIn = User.Identity != null && User.Identity.IsAuthenticated;

    var allGenres = Model.LocalMovies
        .Select(m => m.Genre)
        .Where(g => !string.IsNullOrEmpty(g))
        .Distinct()
        .OrderBy(g => g)
        .ToList();
}
<a id="top"></a>

<div class="container py-4">

    <h2 class="text-center mb-4 display-5" style="color: #ff4444; font-weight: 700;">
        Сите филмови
    </h2>

    <form asp-action="Index" method="get" class="mb-4 d-flex justify-content-center flex-wrap gap-2">
        <input type="text"
               name="searchTerm"
               value="@(ViewData["SearchTerm"] ?? "")"
               placeholder="Пребарај по наслов..."
               class="form-control form-control-lg"
               style="max-width:400px;" />

        <select name="genreFilter" class="form-select form-select-lg" style="max-width:300px;">
            <option value="">Сите жанрови</option>
            @foreach (var g in allGenres)
            {
                <option value="@g" selected="@(string.Equals(ViewData["GenreFilter"]?.ToString(), g, StringComparison.OrdinalIgnoreCase))">
                    @g
                </option>
            }
        </select>

        <button type="submit" class="btn btn-secondary btn-lg">Пребарај</button>
    </form>

    @if (isLoggedIn)
    {
        <div class="d-flex justify-content-end mb-3">
            <a asp-action="Create" class="btn btn-primary btn-lg">+ Додади филм</a>
        </div>
    }

    @if (Model.LocalMovies.Any())
    {
        <h3 class="mb-3 text-center" style="color: #ff4444; font-weight: 700;">Локални филмови</h3>
        <div class="movie-grid">
            @foreach (var movie in Model.LocalMovies)
            {
                <div class="movie-card">
                    <img src="@(!string.IsNullOrEmpty(movie.PosterUrl) ? movie.PosterUrl : Url.Content("~/images/placeholder.png"))"
                         alt="@movie.Title Poster" />
                    <div class="card-body">
                        <h5 class="card-title">@movie.Title @if(movie.Year.HasValue){<span> (@movie.Year)</span>}</h5>
                        @if (!string.IsNullOrEmpty(movie.Plot))
                        {
                            <p class="card-text">@movie.Plot</p>
                        }
                       <div class="d-flex justify-content-center gap-2 mt-2 flex-wrap">
    <a asp-action="Details" asp-route-id="@movie.Id" class="btn-details"> Детали </a>

    @if (isLoggedIn)
    {
        <a asp-action="Edit" asp-route-id="@movie.Id" class="btn btn-warning btn-sm">Уреди</a>
        <a asp-action="Delete" asp-route-id="@movie.Id" class="btn btn-danger btn-sm">Избриши</a>

        <form asp-action="UpdateWatchStatus" asp-route-id="@movie.Id" method="post" class="d-inline-block">
            <select name="status" class="form-select form-select-sm"
                    onchange="this.form.submit()" style="min-width:130px;">
                <option value="0" selected="@(movie.WatchStatus == WatchStatus.NotWatched)">Не е гледан</option>
                <option value="1" selected="@(movie.WatchStatus == WatchStatus.Watching)">Во тек</option>
                <option value="2" selected="@(movie.WatchStatus == WatchStatus.Watched)">Гледан</option>
                <option value="3" selected="@(movie.WatchStatus == WatchStatus.Favorite)">Омилен</option>
            </select>
        </form>
    }
</div>

                        </div>
                    </div>
               
            }
        </div>

        <div class="text-center mt-4">
            <a href="#top" class="btn btn-secondary">Назад кон врв</a>
        </div>
    }

    @if (Model.CineplexxMovies.Any())
    {
        <h3 class="mt-5 mb-3 text-center" style="color: #ff4444; font-weight: 700;">Cineplexx филмови</h3>
        <div class="movie-grid">
            @foreach (var movie in Model.CineplexxMovies)
            {
                <div class="movie-card">
                    <img src="@(!string.IsNullOrEmpty(movie.PosterImage) ? movie.PosterImage : Url.Content("~/images/placeholder.png"))"
                         alt="@movie.Title Poster" />
                    <div class="card-body">
                        <h5 class="card-title">@movie.Title</h5>
                        <div class="d-flex justify-content-center mt-2">
                            <a asp-action="CineplexxDetails" asp-route-id="@movie.Id" class="btn-details"> Детали </a>

                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="text-center mt-5">
            <a href="#top" class="btn btn-secondary">Назад кон врв</a>
        </div>
    }

    @if (Model.UpcomingMovies.Any())
    {
        <h3 class="mt-5 mb-3 text-center" style="color: #ff4444; font-weight: 700;">Наскоро во Cineplexx</h3>

        <div class="movie-grid">
            @foreach (var movie in Model.UpcomingMovies)
            {
                <div class="movie-card position-relative">
                    <span class="upcoming-badge">Наскоро</span>

                    <img src="@(!string.IsNullOrEmpty(movie.PosterImage) ? movie.PosterImage : Url.Content("~/images/placeholder.png"))"
                         alt="@movie.Title Poster" />

                    <div class="card-body">
                        <h5 class="card-title">@movie.Title</h5>
                        <div class="d-flex justify-content-center mt-2">
                          <a href="https://www.cineplexx.mk/film?date=all&category=upcoming" target="_blank" class="btn-details">
    Види повеќе
</a>

                        </div>
                    </div>
                </div>
            }
        </div>

        <div class="text-center mt-4">
            <a href="#top" class="btn btn-secondary">Назад кон врв</a>
        </div>
    }

</div>

@section Scripts {
    <script>
        document.querySelector('select[name="genreFilter"]').addEventListener('change', function () {
            this.form.submit();
        });
    </script>
}
